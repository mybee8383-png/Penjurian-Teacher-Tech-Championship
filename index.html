<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Tech Championship</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold">Teacher Tech Championship</h1>
      <p class="text-slate-600">Input Data • Penjurian • Rekap • Top Wilayah</p>
    </header>

    <!-- Tabs -->
    <div class="mb-4 border-b border-slate-200">
      <nav class="-mb-px flex gap-6 text-sm">
        <button id="tab-config" class="tab-btn border-b-2 border-indigo-600 text-indigo-600 py-3 font-medium">1) Input Data</button>
        <button id="tab-judge"  class="tab-btn border-b-2 border-transparent hover:text-indigo-600 py-3">2) Penjurian</button>
        <button id="tab-recap"  class="tab-btn border-b-2 border-transparent hover:text-indigo-600 py-3">3) Rekap</button>
        <button id="tab-topwil" class="tab-btn border-b-2 border-transparent hover:text-indigo-600 py-3">4) Top per Wilayah</button>
      </nav>
    </div>

    <div id="toast" class="hidden rounded-lg bg-emerald-50 border border-emerald-200 text-emerald-900 px-4 py-3 mb-4 text-sm"></div>

    <!-- ===================== MODUL 1: CONFIG ===================== -->
    <section id="panel-config" class="space-y-6">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-4">A. Daftar Sekolah & Wilayah</h2>
        <div class="flex items-end gap-3 mb-4">
          <label class="block">
            <span class="text-sm">Jumlah Sekolah</span>
            <input id="jumlahSekolah" type="number" min="1" value="4" class="mt-1 w-40 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <button id="btn-gen-sekolah" class="rounded-md bg-slate-800 hover:bg-slate-900 text-white px-4 py-2">Buat Form</button>
        </div>
        <div id="daftarSekolah" class="grid md:grid-cols-2 gap-3"></div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-4">B. Aspek Penilaian & Bobot</h2>
        <div class="flex items-end gap-3 mb-4">
          <label class="block">
            <span class="text-sm">Jumlah Aspek</span>
            <input id="jumlahAspek" type="number" min="1" value="4" class="mt-1 w-40 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <button id="btn-gen-aspek" class="rounded-md bg-slate-800 hover:bg-slate-900 text-white px-4 py-2">Buat Form</button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Nama Aspek</th>
                <th class="px-3 py-2 text-left">Bobot (%)</th>
              </tr>
            </thead>
            <tbody id="tbodyAspek" class="[&_tr:nth-child(even)]:bg-slate-50"></tbody>
            <tfoot class="bg-slate-100">
              <tr>
                <td class="px-3 py-2 font-medium" colspan="2">Total Bobot</td>
                <td class="px-3 py-2 font-semibold">
                  <span id="totalBobot">0</span>% <span id="warnBobot" class="ml-2 text-xs font-medium"></span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-4">C. Jumlah Juri & Simpan</h2>
        <div class="flex items-center gap-4 mb-3">
          <label class="block">
            <span class="text-sm">Jumlah Juri</span>
            <input id="jumlahJuri" type="number" min="1" value="3" class="mt-1 w-40 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
        </div>
        <div class="flex flex-wrap gap-3">
          <button id="btn-save-config" class="rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Simpan Konfigurasi</button>
          <button id="btn-reset" class="rounded-md border border-slate-300 hover:bg-slate-50 px-4 py-2">Reset Semua Data</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Data disimpan di <em>LocalStorage</em>.</p>
      </div>
    </section>

    <!-- ===================== MODUL 2: JUDGING ===================== -->
    <section id="panel-judge" class="hidden space-y-6">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-4">A. Identitas Juri</h2>
        <div class="flex items-end gap-3">
          <label class="block">
            <span class="text-sm">Nama Juri</span>
            <input id="namaJuri" type="text" placeholder="cth: Rina Andini" class="mt-1 w-64 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500"/>
          </label>
          <button id="btn-start-judge" class="rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Mulai</button>
        </div>
      </div>

      <div class="bg-amber-50 border border-amber-200 text-amber-900 rounded-xl p-4 text-sm">
        <strong>Keterangan Nilai:</strong>
        <span class="ml-2">100–90: Istimewa</span> ·
        <span>89–80: Baik Sekali</span> ·
        <span>79–70: Baik</span> ·
        <span>69–60: Cukup</span> ·
        <span>59–50: Kurang</span> ·
        <span>&lt;49: Kurang Sekali</span>
      </div>

      <div id="formPenjurian"></div>
    </section>

    <!-- ===================== MODUL 3: REKAP ===================== -->
    <section id="panel-recap" class="hidden space-y-4">
      <div class="flex gap-3">
        <button id="btn-show-recap" class="rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Tampilkan Rekap</button>
        <button id="btn-clear-judge" class="rounded-md border border-slate-300 hover:bg-slate-50 px-4 py-2">Hapus Semua Nilai Juri</button>
      </div>
      <div id="rekapTabel"></div>
      <p class="text-xs text-slate-500">⚠️ Baris dengan deviasi standar &gt; 5 diberi penanda.</p>
    </section>

    <!-- ===================== MODUL 4: TOP WILAYAH ===================== -->
    <section id="panel-topwil" class="hidden space-y-4">
      <div class="flex gap-3">
        <button id="btn-topwil" class="rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Hitung Top per Wilayah</button>
      </div>
      <div id="tabelTopWil"></div>
      <p class="text-xs text-slate-500">
        *Skor memakai <strong>rata-rata</strong> nilai total antar juri untuk tiap sekolah. Jika ada nilai seri, semua sekolah seri ditampilkan.
      </p>
    </section>
  </div>

  <script>
    /* ========= UTIL ========= */
    const $ = (s) => document.querySelector(s);
    const showToast = (msg, ok=true) => {
      const t = $('#toast'); t.classList.remove('hidden');
      t.className = "rounded-lg px-4 py-3 mb-4 text-sm " + (ok? "bg-emerald-50 border border-emerald-200 text-emerald-900" : "bg-rose-50 border border-rose-200 text-rose-900");
      t.textContent = msg; setTimeout(()=> t.classList.add('hidden'), 2200);
    };
    const getConfig = () => JSON.parse(localStorage.getItem('TTC_config') || 'null');
    const saveConfig = (cfg) => localStorage.setItem('TTC_config', JSON.stringify(cfg));
    const scoreKey = (juri) => `TTC_scores_${juri}`;

    /* ========= TABS ========= */
    const panels = { config: $('#panel-config'), judge: $('#panel-judge'), recap: $('#panel-recap'), topwil: $('#panel-topwil') };
    const markTab = (name) => {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('border-indigo-600','text-indigo-600'));
      if(name==='config') $('#tab-config').classList.add('border-indigo-600','text-indigo-600');
      if(name==='judge')  $('#tab-judge').classList.add('border-indigo-600','text-indigo-600');
      if(name==='recap')  $('#tab-recap').classList.add('border-indigo-600','text-indigo-600');
      if(name==='topwil') $('#tab-topwil').classList.add('border-indigo-600','text-indigo-600');
    };
    const switchTab = (name) => { Object.values(panels).forEach(p=>p.classList.add('hidden')); panels[name].classList.remove('hidden'); markTab(name); };
    $('#tab-config').onclick = ()=> switchTab('config');
    $('#tab-judge').onclick  = ()=> switchTab('judge');
    $('#tab-recap').onclick  = ()=> switchTab('recap');
    $('#tab-topwil').onclick = ()=> switchTab('topwil');

    /* ========= MODUL 1: SEKOLAH ========= */
    function renderSekolahInputs(n){
      const wrap = $('#daftarSekolah'); wrap.innerHTML='';
      for(let i=0;i<n;i++){
        const card = document.createElement('div');
        card.className = "grid grid-cols-2 gap-2 bg-slate-50 border border-slate-200 rounded-lg p-3";
        card.innerHTML = `
          <label class="text-sm">Nama Sekolah
            <input id="sekolah${i}" type="text" class="mt-1 w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Sekolah ${i+1}">
          </label>
          <label class="text-sm">Wilayah
            <input id="wilayah${i}" type="text" class="mt-1 w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Wilayah">
          </label>`;
        wrap.appendChild(card);
      }
    }
    $('#btn-gen-sekolah').onclick = ()=> renderSekolahInputs(parseInt($('#jumlahSekolah').value||'0',10));

    /* ========= MODUL 1: ASPEK ========= */
    function renderAspekInputs(n){
      const tbody = $('#tbodyAspek'); tbody.innerHTML='';
      for(let i=0;i<n;i++){
        const tr = document.createElement('tr');

        const tdNo = document.createElement('td'); tdNo.className="px-3 py-2"; tdNo.textContent=i+1;
        const tdNama = document.createElement('td'); tdNama.className="px-3 py-2";
        const inpNama = document.createElement('input');
        inpNama.id=`aspek${i}`; inpNama.type='text'; inpNama.placeholder=`Aspek ${i+1}`;
        inpNama.className="w-full rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500";
        tdNama.appendChild(inpNama);

        const tdBobot = document.createElement('td'); tdBobot.className="px-3 py-2";
        const inpBobot = document.createElement('input');
        inpBobot.id=`bobot${i}`; inpBobot.type='number'; inpBobot.min='0'; inpBobot.max='100'; inpBobot.step='1';
        inpBobot.className="w-28 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500";
        inpBobot.addEventListener('input', updateTotalBobot);
        tdBobot.appendChild(inpBobot);

        tr.appendChild(tdNo); tr.appendChild(tdNama); tr.appendChild(tdBobot);
        tbody.appendChild(tr);
      }
      updateTotalBobot();
    }
    function updateTotalBobot(){
      const n = parseInt($('#jumlahAspek').value||'0',10); let sum = 0;
      for(let i=0;i<n;i++){ const v = parseFloat($('#bobot'+i)?.value||'0'); sum += isNaN(v)?0:v; }
      $('#totalBobot').textContent = sum;
      const w = $('#warnBobot'); w.textContent = (sum===100? '✓ valid' : 'Total harus 100%');
      w.className = 'ml-2 text-xs font-medium ' + (sum===100? 'text-emerald-700':'text-rose-700');
    }
    $('#btn-gen-aspek').onclick = ()=> renderAspekInputs(parseInt($('#jumlahAspek').value||'0',10));

    /* ========= INIT / LOAD CONFIG ========= */
    (function init(){
      const cfg = getConfig();
      if(cfg){
        $('#jumlahSekolah').value = cfg.sekolahs.length; renderSekolahInputs(cfg.sekolahs.length);
        cfg.sekolahs.forEach((s,i)=>{ $('#sekolah'+i).value=s.nama; $('#wilayah'+i).value=s.wilayah; });

        $('#jumlahAspek').value = cfg.aspek.length; renderAspekInputs(cfg.aspek.length);
        cfg.aspek.forEach((a,i)=>{ $('#aspek'+i).value=a.nama; $('#bobot'+i).value=a.bobot; }); updateTotalBobot();

        $('#jumlahJuri').value = cfg.jumlahJuri || 1;
        showToast('Konfigurasi dimuat');
      }else{
        renderSekolahInputs(parseInt($('#jumlahSekolah').value,10));
        renderAspekInputs(parseInt($('#jumlahAspek').value,10));
      }
    })();

    $('#btn-save-config').onclick = ()=>{
      const nSek = parseInt($('#jumlahSekolah').value||'0',10);
      const sekolahs = [];
      for(let i=0;i<nSek;i++){
        const nama = $('#sekolah'+i)?.value?.trim()||''; const wilayah = $('#wilayah'+i)?.value?.trim()||'';
        if(!nama || !wilayah){ showToast('Nama sekolah & wilayah wajib diisi', false); return; }
        sekolahs.push({nama, wilayah});
      }
      const nAsp = parseInt($('#jumlahAspek').value||'0',10);
      const aspek = []; let sum = 0;
      for(let i=0;i<nAsp;i++){
        const nama = $('#aspek'+i)?.value?.trim()||''; const bobot = parseFloat($('#bobot'+i)?.value||'0');
        if(!nama){ showToast('Nama aspek tidak boleh kosong', false); return; }
        if(isNaN(bobot)){ showToast('Bobot harus angka', false); return; }
        aspek.push({nama, bobot}); sum += bobot;
      }
      if(sum!==100){ showToast('Total bobot harus = 100%', false); return; }
      const jumlahJuri = Math.max(1, parseInt($('#jumlahJuri').value||'1',10));
      saveConfig({sekolahs, aspek, jumlahJuri});
      showToast('Konfigurasi tersimpan ✓');
    };

    $('#btn-reset').onclick = ()=>{
      if(!confirm('Hapus semua data (config & nilai juri)?')) return;
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith('TTC_')) localStorage.removeItem(k); });
      location.reload();
    };

    /* ========= MODUL 2: PENJURIAN ========= */
    $('#btn-start-judge').onclick = ()=>{
      const cfg = getConfig(); if(!cfg){ showToast('Konfigurasi belum disimpan', false); switchTab('config'); return; }
      const nama = $('#namaJuri').value.trim(); if(!nama){ showToast('Nama juri wajib diisi', false); return; }

      const wrap = $('#formPenjurian'); wrap.innerHTML = '';
      const table = document.createElement('table');
      table.className = "min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden";
      table.innerHTML = `
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">Sekolah</th>
            ${cfg.aspek.map(a=>`<th class="px-3 py-2 text-left">${a.nama} <span class="text-xs text-slate-500">(${a.bobot}%)</span></th>`).join('')}
            <th class="px-3 py-2 text-left">Total</th>
          </tr>
        </thead>
        <tbody id="tbodyJudge" class="[&_tr:nth-child(even)]:bg-slate-50"></tbody>`;
      const box = document.createElement('div'); box.className = "overflow-x-auto"; box.appendChild(table); wrap.appendChild(box);

      const body = table.querySelector('#tbodyJudge');
      const draft = JSON.parse(localStorage.getItem(scoreKey(nama))||'null');

      cfg.sekolahs.forEach((s, idxS)=>{
        const tr = document.createElement('tr');

        const tdSek = document.createElement('td'); tdSek.className="px-3 py-2 whitespace-nowrap";
        tdSek.innerHTML = `${s.nama} <span class="text-xs text-slate-500">(${s.wilayah})</span>`;
        tr.appendChild(tdSek);

        cfg.aspek.forEach((a, idxA)=>{
          const td = document.createElement('td'); td.className="px-3 py-2";
          const inp = document.createElement('input');
          inp.type='number'; inp.min='0'; inp.max='100'; inp.step='1';
          inp.id=`nilai_${idxS}_${idxA}`;
          inp.className="w-24 rounded-md border-slate-300 focus:border-indigo-500 focus:ring-indigo-500";

          const pred = document.createElement('div'); pred.id=`pred_${idxS}_${idxA}`; pred.className="text-[11px] text-slate-500 mt-1";

          if(draft && draft.nilai){
            const rec = draft.nilai.find(n => n.sekolah===s.nama);
            if(rec && rec.nilai[a.nama] !== undefined){ inp.value = rec.nilai[a.nama]; pred.textContent = kategori(+inp.value); }
          }

          inp.addEventListener('input', ()=>{
            let v = parseFloat(inp.value||'0'); if(v<0)v=0; if(v>100)v=100; inp.value=v;
            pred.textContent = kategori(v); hitungTotalBaris(cfg, idxS); saveJudge(nama, false, cfg);
          });

          td.appendChild(inp); td.appendChild(pred); tr.appendChild(td);
        });

        const tdTot = document.createElement('td'); tdTot.className="px-3 py-2 font-medium"; tdTot.id=`total_${idxS}`;
        const totDraft = draft && draft.nilai ? draft.nilai.find(n=>n.sekolah===s.nama)?.nilai.total : 0;
        tdTot.textContent = (totDraft? totDraft : 0).toFixed(2);
        tr.appendChild(tdTot);

        body.appendChild(tr);
      });

      const actions = document.createElement('div'); actions.className="mt-3 flex gap-3";
      const btnSave = document.createElement('button'); btnSave.className="rounded-md bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2"; btnSave.textContent="Simpan Nilai";
      btnSave.onclick = ()=> saveJudge(nama, true, cfg);
      actions.appendChild(btnSave);
      const note = document.createElement('span'); note.className="text-xs text-slate-500"; note.textContent="Autosave aktif saat Anda mengetik.";
      actions.appendChild(note);
      wrap.appendChild(actions);

      switchTab('judge'); showToast(`Form penjurian untuk ${nama} siap`);
    };

    function kategori(v){ return (v>=90)?'Istimewa':(v>=80)?'Baik Sekali':(v>=70)?'Baik':(v>=60)?'Cukup':(v>=50)?'Kurang':'Kurang Sekali'; }
    function hitungTotalBaris(cfg, idxS){
      let total=0; cfg.aspek.forEach((a, idxA)=>{ const v = parseFloat(($('#nilai_'+idxS+'_'+idxA)?.value)||'0'); total += v*(a.bobot/100); });
      $('#total_'+idxS).textContent = total.toFixed(2);
    }
    function saveJudge(nama, notify, cfg){
      cfg = cfg || getConfig(); if(!cfg) return;
      const data = { namaJuri: nama, nilai: [] };
      cfg.sekolahs.forEach((s, idxS)=>{
        const pack = { sekolah: s.nama, nilai: {} }; let total=0;
        cfg.aspek.forEach((a, idxA)=>{ const v = parseFloat(($('#nilai_'+idxS+'_'+idxA)?.value)||'0'); pack.nilai[a.nama]=v; total += v*(a.bobot/100); });
        pack.nilai.total = parseFloat(total.toFixed(2)); data.nilai.push(pack);
      });
      localStorage.setItem(scoreKey(nama), JSON.stringify(data));
      if(notify) showToast('Nilai juri tersimpan ✓');
    }

    /* ========= MODUL 3: REKAP ========= */
    $('#btn-show-recap').onclick = ()=>{
      const cfg = getConfig(); if(!cfg){ showToast('Konfigurasi belum ada', false); switchTab('config'); return; }
      const juriNames = []; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k.startsWith('TTC_scores_')) juriNames.push(k.replace('TTC_scores_','')); }
      if(juriNames.length===0){ showToast('Belum ada nilai juri', false); return; }

      const wrap = $('#rekapTabel'); wrap.innerHTML='';
      const table = document.createElement('table'); table.className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden";
      table.innerHTML = `
        <thead class="bg-slate-50"><tr>
          <th class="px-3 py-2 text-left">Sekolah</th>
          ${juriNames.map(n=>`<th class="px-3 py-2 text-left">${n}</th>`).join('')}
          <th class="px-3 py-2 text-left">Rata-rata</th>
          <th class="px-3 py-2 text-left">SD</th>
          <th class="px-3 py-2 text-left">Warning</th>
        </tr></thead>
        <tbody id="tbodyRecap" class="[&_tr:nth-child(even)]:bg-slate-50"></tbody>`;
      const box = document.createElement('div'); box.className="overflow-x-auto"; box.appendChild(table); wrap.appendChild(box);

      const body = table.querySelector('#tbodyRecap');
      cfg.sekolahs.forEach((s)=>{
        const totals = juriNames.map(n=>{
          const rec = JSON.parse(localStorage.getItem(scoreKey(n))||'null'); if(!rec) return null;
          const row = rec.nilai.find(r=>r.sekolah===s.nama); return row && typeof row.nilai.total==='number' ? row.nilai.total : null;
        }).filter(v=>v!==null);
        const avg = totals.length? totals.reduce((a,b)=>a+b,0)/totals.length : 0;
        const variance = totals.length? totals.reduce((a,b)=>a+Math.pow(b-avg,2),0)/totals.length : 0;
        const sd = Math.sqrt(variance); const warn = sd>5 ? '⚠️ SD > 5' : '';

        const tr = document.createElement('tr'); if(sd>5) tr.className="bg-amber-50";
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap">${s.nama}</td>
          ${juriNames.map(n=>{
            const rec = JSON.parse(localStorage.getItem(scoreKey(n))||'null'); if(!rec) return `<td class="px-3 py-2">-</td>`;
            const row = rec.nilai.find(r=>r.sekolah===s.nama); const val = row && typeof row.nilai.total==='number' ? row.nilai.total.toFixed(2) : '-';
            return `<td class="px-3 py-2">${val}</td>`;
          }).join('')}
          <td class="px-3 py-2 font-medium">${avg.toFixed(2)}</td>
          <td class="px-3 py-2">${sd.toFixed(2)}</td>
          <td class="px-3 py-2">${warn}</td>`;
        body.appendChild(tr);
      });

      switchTab('recap');
    };
    $('#btn-clear-judge').onclick = ()=>{
      if(!confirm('Hapus semua nilai juri (config tetap ada)?')) return;
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith('TTC_scores_')) localStorage.removeItem(k); });
      $('#rekapTabel').innerHTML = ''; showToast('Semua nilai juri dihapus');
    };

    /* ========= MODUL 4: TOP PER WILAYAH ========= */
    $('#btn-topwil').onclick = ()=>{
      const cfg = getConfig(); if(!cfg){ showToast('Konfigurasi belum ada', false); switchTab('config'); return; }

      // kumpulkan nama juri
      const juriNames = []; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k.startsWith('TTC_scores_')) juriNames.push(k.replace('TTC_scores_','')); }
      if(juriNames.length===0){ showToast('Belum ada nilai juri', false); return; }

      // hitung rata-rata total per sekolah, lalu kelompokkan per wilayah
      const byRegion = {}; // { "Papua": [{school:"Sekolah 1", avg:87.3, n:3}, ...], ... }
      cfg.sekolahs.forEach((s)=>{
        const totals = [];
        juriNames.forEach(n=>{
          const rec = JSON.parse(localStorage.getItem(scoreKey(n))||'null'); if(!rec) return;
          const row = rec.nilai.find(r=>r.sekolah===s.nama);
          if(row && typeof row.nilai.total==='number') totals.push(row.nilai.total);
        });
        if(totals.length){
          const avg = totals.reduce((a,b)=>a+b,0)/totals.length;
          (byRegion[s.wilayah] ||= []).push({ school: s.nama, avg, n: totals.length });
        }
      });

      // buat tabel hasil
      const wrap = $('#tabelTopWil'); wrap.innerHTML='';
      const table = document.createElement('table'); table.className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden";
      table.innerHTML = `
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left">Wilayah</th>
            <th class="px-3 py-2 text-left">Sekolah Tertinggi</th>
            <th class="px-3 py-2 text-left">Skor (Rata-rata)</th>
            <th class="px-3 py-2 text-left">#Juri</th>
          </tr>
        </thead>
        <tbody id="tbodyTopWil" class="[&_tr:nth-child(even)]:bg-slate-50"></tbody>`;
      const box = document.createElement('div'); box.className="overflow-x-auto"; box.appendChild(table); wrap.appendChild(box);

      const body = table.querySelector('#tbodyTopWil');

      const regions = Object.keys(byRegion);
      if(regions.length===0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-3 py-2" colspan="4">Belum ada skor rata-rata yang bisa dihitung.</td>`;
        body.appendChild(tr);
      } else {
        regions.sort().forEach(region=>{
          const list = byRegion[region];
          // cari nilai tertinggi
          const maxAvg = Math.max(...list.map(x=>x.avg));
          const tops = list.filter(x=> Math.abs(x.avg - maxAvg) < 1e-9); // handle floating tie
          const names = tops.map(t=>t.school).join(', ');
          const juris = Math.max(...tops.map(t=>t.n)); // info #juri terbanyak di kandidat top

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap">${region}</td>
            <td class="px-3 py-2">${names}</td>
            <td class="px-3 py-2 font-medium">${maxAvg.toFixed(2)}</td>
            <td class="px-3 py-2">${juris}</td>`;
          body.appendChild(tr);
        });
      }

      switchTab('topwil');
    };

  </script>
</body>
</html>
